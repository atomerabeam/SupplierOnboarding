sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","../model/models","sap/m/MessageToast"],function(e,t,o,r){"use strict";return e.extend("vbipsupplier.controller.CardLandingPage",{onInit:async function(){this.getOwnerComponent().getModel("SupplierInfo").setProperty("/supplier",{});this.getOwnerComponent().getModel("SupplierInfo").setProperty("/buyer",{});this.getOwnerComponent().getModel("SupplierInfo").setProperty("/VBIP",{});let e=new t;let r={otp:false,landing:false};e.setProperty("/pageFlow",r);this.getView().setModel(e,"PageModel");let n=sap.ui.core.UIComponent.getRouterFor(this);n.getRoute("Card").attachPatternMatched(this._onObjectMatched,this);await o.checkService();let s={pID:this._GUID};let i=await o.decryptID(s);let l={buyerID:i.response.value.split("_")[0],supplierID:i.response.value.split("_")[1]};let p=await o.getSupplier(l);if(p.response){if(p.response.error){let e=`Failed to get Supplier information \nError code ${p.response.error.code}`;this.getView().getModel("PageModel").setProperty("/pageFlow/landing",true)}else{if(p.response.supplier.error){this.getView().getModel("PageModel").setProperty("/pageFlow/landing",true)}else if(p.response.supplier){this.getView().getModel("PageModel").setProperty("/pageFlow/landing",false);this.getOwnerComponent().getModel("SupplierInfo").setProperty("/supplier",p.response.supplier);console.log(this.getOwnerComponent().getModel("SupplierInfo"));await this._getBuyerInfo(p.response.supplier.buyerID);this.onResendOTPLinkPress();this.getView().getModel("PageModel").setProperty("/pageFlow/otp",true)}}}else{let e=`Failed to get Supplier information \nError catched`;this.getView().getModel("PageModel").setProperty("/pageFlow/landing",true)}},onResendOTPLinkPress:async function(){let e=this.getOwnerComponent().getModel("SupplierInfo").getProperty("/supplier");let t=this.getOwnerComponent().getModel("SupplierInfo").getProperty("/VBIP");let n=e.emailID;let s={pID:this._GUID,smtpDestination:t.smtpDestination,mailTo:n,mailSubject:"VBIP Supplier OTP",mailContent:`<strong>Dear Supplier</strong><br/><br/>\n                                <p>Your OTP code is [OTP]</p><br/><p>Thanks</p>`};let i=await o.sendMailOTP(s);if(i.response.ok===true){r.show("Sent OTP")}else{r.show("Failed to send OTP")}},onContinueButtonPress:async function(){let e=this.getView().byId("idOTP.Input").getValue();let t={pID:this._GUID,pOTP:e};let n=await o.checkOTP(t);if(Object.keys(n.catchError).length===0&&n.catchError.constructor===Object){if(n.response.error){let e=`Failed to process \nError code ${n.response.error.code}`;r.show(e)}else{let e=n.response.value;let t;if(e==="Invalid"){t="Invalid OTP";r.show(t)}else if(e==="Expired"){t="Your OTP is expired";r.show(t)}else if(e==="OK"){let e=this.getOwnerComponent().getRouter();e.navTo("CardInfo")}}}else{let e=`Failed to process \nError catched`;r.show(e)}},_getBuyerInfo:async function(e){let t={buyerID:e};let r=await o.getBuyer(t);if(r.response.value){this.getOwnerComponent().getModel("SupplierInfo").setProperty("/buyer",r.response.value.buyer)}let n=await o.getBuyerOnboarding(t);if(n.response.value.buyerOnboarding.value[0]){let e={pID:n.response.value.buyerOnboarding.value[0].vbipID};let t=await o.getVBIP(e);if(t.response.value){this.getOwnerComponent().getModel("SupplierInfo").setProperty("/VBIP",t.response.value.vbip)}}},_onObjectMatched:function(e){this._GUID=e.getParameter("arguments").token}})});