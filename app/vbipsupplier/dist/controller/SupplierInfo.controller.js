sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","../model/models","sap/m/MessageToast"],function(e,t,o,l){"use strict";return e.extend("vbipsupplier.controller.SupplierInfo",{onInit:function(){let e=sap.ui.core.UIComponent.getRouterFor(this);e.getRoute("SupplierInfo").attachPatternMatched(this._onObjectMatched,this)},onContinue:function(){this.getView().getModel("PageModel").setProperty("/pageFlow/infoRequest",false);let e=this.getView().byId("idAcceptCard.Select").getSelectedKey();if(e==="true"){this.getView().getModel("PageModel").setProperty("/pageFlow/complete",true)}else{this.getView().getModel("PageModel").setProperty("/pageFlow/infoConfirm",true)}},onConfirmInfo:function(){this.getView().getModel("PageModel").setProperty("/pageFlow/infoConfirm",false);this.getView().getModel("PageModel").setProperty("/pageFlow/corporate",true)},onContinueStep1:function(){this.getView().getModel("PageModel").setProperty("/pageFlow/corporate",false);this.getView().getModel("PageModel").setProperty("/pageFlow/shareholder",true)},onContinueStep2:function(){this.getView().getModel("PageModel").setProperty("/pageFlow/shareholder",false);this.getView().getModel("PageModel").setProperty("/pageFlow/complete",true);this._updateSupplier("noMessage")},onReportInfo:function(){},onSaveAndExit:async function(){this._updateSupplier("message");this.getView().getModel("PageModel").setProperty("/pageFlow/corporate",false);this.getView().getModel("PageModel").setProperty("/pageFlow/shareholder",false);this.getView().getModel("PageModel").setProperty("/pageFlow/infoRequest",true)},onChangeBusinessNature:function(){let e=parseInt(this.getView().byId("idBusinessNature.Select").getSelectedKey());let t;let o=this.getView().getModel("DocumentModel").getProperty("/docKeys");if(e===1){t=4;o=[1,2,3,4,5]}else if(e===2){t=6;o=[1,5,6]}else if(e===3){t=1;o=[7,8,9]}else{t=4;o=[1,2,3,4,5]}let l=[];for(let e=1;e<=t;e++){l.push({count:e})}for(let e=1;e<=9;e++){let t=this.getView().getModel("DocumentModel").getProperty("/doc"+e);if(o.includes(e)){t.visible=true}else{t.visible=false}this.getView().getModel("DocumentModel").setProperty("/doc"+e,t)}this.getView().getModel("DocumentModel").setProperty("/docKeys",o);this.getView().getModel("F4").setProperty("/shareholderItem",l)},onChangeShareCount:function(){let e=new t;this.getView().setModel(e,"ShareholderModel");let o=this.getView().getModel("F4").getProperty("/shareholderCount");let l=[];for(let e=1;e<=o;e++){l.push({enterInfo:true,completed:false,name:"",sharePercentage:"",address:"",docType:"",docNum:"",nameOnDoc:"",dateOfIssue:"",filename:"",fileType:"",fileData:"",uploadVisible:true,fileVisible:false})}this.getView().getModel("ShareholderModel").setProperty("/item",l)},onUploadFileButton:async function(e){let t=e.getParameter("id");let i=t.split("idUploadFile")[1].split(".Button")[0];let r=document.createElement("input");r.type="file";r.multiple=true;r.accept="image/*";let s;r.onchange=async function(){let e=r.files;s=e;for(let o=0;o<e.length;o++){let l=e[o];let i=await l.arrayBuffer();let r=await l.text();var t=new Uint8Array(i);var a=t.byteLength;var n="";for(let e=0;e<a;e++){n+=String.fromCharCode(t[e])}n=btoa(n)}let p={fileContent:n};let u=await o.checkMalware(p);if(u==="true"){let e="Malware is detected";l.show(e)}else{let e=this.getView().getModel("DocumentModel").getProperty("/doc"+i);e.fileName=s[0].name;e.fileType=s[0].type;e.fileData=n;e.uploadVisible=false;e.fileVisible=true;this.getView().getModel("DocumentModel").setProperty("/doc"+i,e)}}.bind(this);r.click()},onDeleteFileButton:async function(e){let t=e.getParameter("id");let o=t.split("idDeleteFile")[1].split(".Icon")[0];let l=this.getView().getModel("DocumentModel").getProperty("/doc"+o);l.fileName=null;l.fileType=null;l.fileData=null;l.uploadVisible=true;l.fileVisible=false;this.getView().getModel("DocumentModel").setProperty("/doc"+o,l)},onDownloadFileButton:async function(e){let t=e.getParameter("id");let o=t.split("idDownloadFile")[1].split(".Icon")[0];let l=this.getView().getModel("DocumentModel").getProperty("/doc"+o);const i=document.createElement("a");let r=l.fileType;i.href="data:"+r+";base64,"+l.fileData;i.download=l.fileName;i.click()},onUploadFileSH:async function(e){let t=this.getView().getModel("ShareholderPopupModel").getProperty("/popup");let i=document.createElement("input");i.type="file";i.multiple=true;i.accept="image/*";let r;let s;i.onchange=async function(){let e=i.files;r=e;for(let t=0;t<e.length;t++){let o=e[t];let l=await o.arrayBuffer();let i=await o.text();let r=new Uint8Array(l);let a=r.byteLength;for(let e=0;e<a;e++){s+=String.fromCharCode(r[e])}s=btoa(s)}let a={fileContent:s};let n=await o.checkMalware(a);if(n==="true"){let e="Malware is detected";l.show(e)}else{t.fileName=r[0].name;t.fileType=r[0].type;t.fileData=s;t.uploadVisible=false;t.fileVisible=true;this.getView().getModel("ShareholderPopupModel").setProperty("/popup",t)}}.bind(this);i.click()},onDeleteFileSH:async function(e){let t=this.getView().getModel("ShareholderPopupModel").getProperty("/popup");t.fileName=null;t.fileType=null;t.fileData=null;t.uploadVisible=true;t.fileVisible=false;this.getView().getModel("ShareholderPopupModel").setProperty("/popup",t)},onDownloadFileSH:async function(e){let t=this.getView().getModel("ShareholderPopupModel").getProperty("/popup");const o=document.createElement("a");o.href="data:"+t.fileType+";base64,"+t.fileData;o.download=t.fileName;o.click()},onEnterShareholderPopup:function(e){let o=e.getSource().getBindingContext("ShareholderModel");let l=this.getView().getModel("ShareholderModel").getProperty(o.getPath());l.path=o.getPath();let i=new t;i.setProperty("/popup",l);this.getView().setModel(i,"ShareholderPopupModel");if(!this._oDialog){this._oDialog=new sap.ui.xmlfragment("vbipsupplier.view.fragment.ShareholderPopup",this);this.getView().addDependent(this._oDialog)}this._oDialog.open()},onDialogAfterClose:function(){this._oDialog.destroy();this._oDialog=null},onSave:function(){let e=this.getView().getModel("ShareholderPopupModel").getProperty("/popup");let t={path:e.path,enterInfo:false,completed:true,name:e.name,sharePercentage:e.sharePercentage,address:e.address,docType:e.docType,docNum:e.docNum,nameOnDoc:e.nameOnDoc,dateOfIssue:e.dateOfIssue,filename:e.fileName,fileType:e.fileType,fileData:e.fileData,uploadVisible:false,fileVisible:true};this.getView().getModel("ShareholderModel").setProperty(`${e.path}`,t);this.onDialogAfterClose()},onCancel:function(){this.onDialogAfterClose()},_onInit:async function(){let e=new t;let l={infoRequest:false,infoConfirm:false,corporate:false,shareholder:false,complete:false};e.setProperty("/pageFlow",l);this.getView().setModel(e,"PageModel");let i=new t;i.setProperty("/shareholderCount",1);let r=await o.getBusinessNature();let s;if(r.response.value){s=r.response.value.businessNature.value}i.setProperty("/businessNature",s);this.getView().setModel(i,"F4");let a=new t;for(let e=1;e<=9;e++){a.setProperty("/doc"+e,{visible:false,nameOnDocument:null,documentNumber:null,fileName:null,fileType:null,fileData:null,uploadVisible:true,fileVisible:false})}a.setProperty("/docKeys",[1,2,3,4,5,6,7,8,9]);this.getView().setModel(a,"DocumentModel");let n=new t;let p,u;let d=this.getOwnerComponent().getModel("SupplierInfo").getProperty("/supplier");if(d!==undefined){if(d.SAPCustomer==="true"){p="true"}else if(d.SAPCustomer==="false"){p="false"}else if(d.SAPCustomer===null){p="true"}if(d.status==="CardAccepted"){u="true"}else{u="false"}let e={SAPCustomer:p,acceptCard:u};n.setProperty("/requestInfo",e);this.getView().setModel(n,"RequestInfo");this.getView().getModel("PageModel").setProperty("/pageFlow/infoRequest",true);let t=d.supplierDocuments;for(let e=0;e<=t.length-1;e++){let o={visible:true,nameOnDocument:t[e].nameOnDocument,documentNumber:t[e].documentNumber,fileName:t[e].fileName,fileType:t[e].fileType,fileData:null,uploadVisible:false,fileVisible:true};this.getView().getModel("DocumentModel").setProperty("/doc"+t[e].documentType,o)}}else{let e=this.getOwnerComponent().getRouter();e.navTo("Supplier",{GUID:"NotFound"})}this.onChangeBusinessNature();this.onChangeShareCount()},_onObjectMatched:function(e){this._onInit()},_updateSupplier:async function(e){let t=this.getOwnerComponent().getModel("SupplierInfo").getProperty("/supplier");let i=this.getView().getModel("DocumentModel").getProperty("/docKeys");let r=[];for(let e=0;e<=i.length-1;e++){let l=this.getView().getModel("DocumentModel").getProperty("/doc"+i[e]);let s={ID:t.supplierID,fileContent:l.fileData};let a=await o.encryptFile(s);r.push({documentName:"doc"+i[e],documentType:i[e].toString(),nameOnDocument:l.nameOnDocument,documentNumber:l.documentNumber,fileName:l.fileName,fileType:l.fileType,encodedContent:a.response.value})}let s=parseInt(this.getView().byId("idShareholderCount.Select").getSelectedKey());let a=[];for(let e=0;e<=s-1;e++){let l=this.getView().getModel("ShareholderModel").getProperty("/item/"+e);let i={ID:t.supplierID,fileContent:l.fileData};let r=await o.encryptFile(i);a.push({shareholderName:l.name,sharePercentage:parseInt(l.sharePercentage),shareholderDocuments:[{documentType:l.docType,nameOnDocument:l.nameOnDoc,documentNumber:l.docNum,fileName:l.fileName,fileType:l.fileType,encodedContent:r.response.value,expiryDate:l.expiryDate}]})}let n={status:"Saved",SAPCustomer:this.getView().byId("idSAPCustomer.Select").getSelectedKey().toLowerCase()==="true",businessNature_selectKey:parseInt(this.getView().byId("idBusinessNature.Select").getSelectedKey()),shareholderCount:s,supplierDocuments:r,shareholderDetails:a};let p={buyerID:t.buyerID,supplierID:t.supplierID,oSupplier:n};let u=await o.updateSupplier(p);if(Object.keys(u.catchError).length===0&&u.catchError.constructor===Object){if(u.response.error){let e=`Operation failed Supplier ${t.supplierID} \nError code ${u.response.error.code}`}else{let o=`Supplier ${t.supplierID} information is update`;if(e==="message"){l.show(o)}this._submitSupplier("")}}else{let e=`Operation failed Supplier ${t.supplierID} \nError catched`}},_submitSupplier:async function(e){let t=this.getOwnerComponent().getModel("SupplierInfo").getProperty("/supplier");let i=this.getView().getModel("ShareholderModel").getProperty("/item");i.forEach(e=>e.sharePercentage=parseInt(e.sharePercentage));let r={vbipRequestId:t.buyerID+t.supplierID,businessNature:t.businessNature_selectKey,shareHolderCount:t.shareholderCount,isCardAcceptor:this.getView().byId("idAcceptCard.Select").getSelectedKey().toLowerCase()==="true",buyerId:t.buyerID,supplierInfo:{supplierId:t.supplierID,firstName:t.firstName,lastName:t.lastName,legalName:t.supplierName,emailAddress:t.emailID,mobileNumberCountryCode:t.mobileCountryCode,mobileNumber:t.mobileNumber,completeAddress:t.completeAddress,zipCode:t.zipCode,countryCode:t.countryCode_code,city:t.city,state:t.state},kycDetails:{addressProof:{documentName:"",nameOnDocument:"",documentNumber:"",fileName:"",encodedContent:""},businessProof:[{expiryDate:"",documentName:"copyOfBusinessReg",nameOnDocument:this.getView().byId("idNameDoc1.Input").getValue(),documentNumber:this.getView().byId("idDocNum1.Input").getValue(),fileName:this.getView().getModel("DocumentModel").getProperty("/doc1/fileName"),encodedContent:this.getView().getModel("DocumentModel").getProperty("/doc1/fileData")}]},supplierBankingInfo:{accountHolderName:t.supplierName,accountNumber:t.accountNumber,branchCity:"",bankCode:t.bankCode}};let s={oSupplier:r};let a=await o.submitSupplier(s);if(Object.keys(a.catchError).length===0&&a.catchError.constructor===Object){if(a.response.error){let e=`Operation failed Supplier ${t.supplierID} \nError code ${a.response.error.code}`}else{let o=`Supplier ${t.supplierID} information is submitted`;if(e==="message"){l.show(o)}}}else{let e=`Operation failed Supplier ${t.supplierID} \nError catched`}}})});