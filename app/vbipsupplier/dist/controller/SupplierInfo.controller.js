sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","../model/models","sap/m/MessageToast","../model/formatter","sap/m/MessageBox"],function(e,t,o,l,r,i){"use strict";return e.extend("vbipsupplier.controller.SupplierInfo",{formatter:r,onInit:function(){let e=sap.ui.core.UIComponent.getRouterFor(this);e.getRoute("SupplierInfo").attachPatternMatched(this._onObjectMatched,this);this.getView().addEventDelegate({onBeforeShow:this.onBeforeShow},this)},onBeforeShow:function(){let e=new t;let o={infoRequest:false,infoConfirm:false,corporate:false,shareholder:false,complete:false};e.setProperty("/pageFlow",o);this.getView().setModel(e,"PageModel");let l=this.getOwnerComponent().getModel("SupplierInfo").getProperty("/supplier");if(!l){let e=this.getOwnerComponent().getRouter();e.navTo("Supplier",{GUID:"NotFound"})}},onContinue:function(){let e=this.getView().byId("idAcceptCard.Select").getSelectedKey();if(e==="true"){this._updateSupplier("message","CAC",false,false);this.getView().getModel("PageModel").setProperty("/pageFlow/complete",true);this.getView().getModel("PageModel").setProperty("/pageFlow/infoRequest",false)}else{let e=this.getOwnerComponent().getModel("SupplierInfo").getProperty("/supplier");let t=this.getOwnerComponent().getModel("SupplierInfo").getProperty("/buyer");if(e.countryCode_code===t.countryCode_code){this.getView().getModel("PageModel").setProperty("/pageFlow/infoConfirm",true);this.getView().getModel("PageModel").setProperty("/pageFlow/infoRequest",false)}else{const e="Cannot be onboarded";const t=`As your country is different from Buyer's country, and you are not accepting card payments.\n\n                                          Cannot continue the process, please contact to VISA about this case`;let o=async function(e){this._updateSupplier("noMessage","NOB",false,false);this.getOwnerComponent().getModel("SupplierInfo").destroy();this._endSession()}.bind(this);this.showErrorMessageBox(e,t,o)}}},onConfirmInfo:function(){this.getView().getModel("PageModel").setProperty("/pageFlow/infoConfirm",false);this.getView().getModel("PageModel").setProperty("/pageFlow/corporate",true)},onContinueStep1:function(){this.getView().getModel("PageModel").setProperty("/pageFlow/corporate",false);this.getView().getModel("PageModel").setProperty("/pageFlow/shareholder",true)},onSubmit:function(){this._updateSupplier("noMessage","SUB",true,true);this._submitSupplier("message");this.getView().getModel("PageModel").setProperty("/pageFlow/shareholder",false);this.getView().getModel("PageModel").setProperty("/pageFlow/complete",true)},onReportInfo:function(){const e=this.getOwnerComponent().getModel("i18n").getProperty("reportInfoMessageTitle");let t=this.getOwnerComponent().getModel("SupplierInfo").getProperty("/buyer/legalName");const r=this.getOwnerComponent().getModel("i18n").getProperty("reportInfoMessage").replaceAll("[Buyer]",t);let i=this.getOwnerComponent().getModel("SupplierInfo").getProperty("/supplier");let n={sBuyerID:i.buyerID,sSupplierID:i.supplierID};let s=this.getOwnerComponent().getModel("AuthModel").getProperty("/authToken");let a=async function(e){if(e=="OK"){let e=await o.reportInfo(n,s);if(e.ok){this._endSession()}else{l.show(`Failed to update, please try again`)}}else{l.show(`Action is cancelled by user`)}}.bind(this);this.showErrorMessageBox(e,r,a)},onSaveAndExit:async function(){this._updateSupplier("message","SAV",true,true);this.getView().getModel("PageModel").setProperty("/pageFlow/corporate",false);this.getView().getModel("PageModel").setProperty("/pageFlow/shareholder",false);this.getView().getModel("PageModel").setProperty("/pageFlow/infoRequest",true)},showErrorMessageBox:function(e,t,o){i.error(t,{title:e,actions:[sap.m.MessageBox.Action.OK],onClose:o})},onChangeAcceptCard:function(){let e=this.getView().byId("idAcceptCard.Select").getSelectedKey();if(e.toLowerCase()==="true"){this.getView().getModel("RequestInfo").setProperty("/requestInfo/infoBoxVisible",false)}else{this.getView().getModel("RequestInfo").setProperty("/requestInfo/infoBoxVisible",true)}},onChangeBusinessNature:function(){let e=parseInt(this.getView().byId("idBusinessNature.Select").getSelectedKey());let t;let o=this.getView().getModel("DocumentModel").getProperty("/docKeys");if(e===1){t=4;o=[1,2,3,4,5]}else if(e===2){t=6;o=[1,5,6]}else if(e===3){t=1;o=[7,8,9]}else{t=4;o=[1,2,3,4,5]}let l=[];for(let e=1;e<=t;e++){l.push({count:e})}for(let e=1;e<=9;e++){let t=this.getView().getModel("DocumentModel").getProperty("/doc"+e);if(o.includes(e)){t.visible=true}else{t.visible=false}this.getView().getModel("DocumentModel").setProperty("/doc"+e,t)}this.getView().getModel("DocumentModel").setProperty("/docKeys",o);this.getView().getModel("F4").setProperty("/shareholderItem",l)},onChangeShareCount:function(){let e=new t;this.getView().setModel(e,"ShareholderModel");let o=this.getView().getModel("F4").getProperty("/shareholderCount");if(o===null){o=1}let l=[];for(let e=1;e<=o;e++){l.push({enterInfo:true,completed:false,name:"",sharePercentage:"",address:"",docType:"",docNum:"",nameOnDoc:"",dateOfIssue:"",filename:"",fileType:"",fileData:"",uploadVisible:true,fileVisible:false})}this.getView().getModel("ShareholderModel").setProperty("/item",l)},onUploadFileButton:async function(e){let t=this.getOwnerComponent().getModel("AuthModel").getProperty("/authToken");let r=e.getParameter("id");let i=r.split("idUploadFile")[1].split(".Button")[0];let n=["image/png","application/pdf","image/jpeg","image/gif"];let s=document.createElement("input");s.type="file";s.multiple=false;s.accept="image/*";let a;s.onchange=async function(){let e=s.files;a=e;for(let s=0;s<e.length;s++){if(n.includes(e[s].type)){let n=e[s];let d=await n.arrayBuffer();let g=await n.text();var r=new Uint8Array(d);var p=r.byteLength;var u="";for(let e=0;e<p;e++){u+=String.fromCharCode(r[e])}u=btoa(u);let c={fileContent:u};let f=await o.checkMalware(c,t);if(f==="true"){let e="Malware is detected";l.show(e)}else{let e=this.getView().getModel("DocumentModel").getProperty("/doc"+i);e.fileName=a[0].name;e.fileType=a[0].type;e.fileData=u;e.uploadVisible=false;e.fileVisible=true;this.getView().getModel("DocumentModel").setProperty("/doc"+i,e);this.onCheckComplete()}}else{this.showErrorMessageBox("Error","Invalid file type. Please select a PNG, PDF, or JPEG file.",null)}}}.bind(this);s.click()},onDeleteFileButton:async function(e){let t=e.getParameter("id");let o=t.split("idDeleteFile")[1].split(".Icon")[0];let l=this.getView().getModel("DocumentModel").getProperty("/doc"+o);l.fileName=null;l.fileType=null;l.fileData=null;l.uploadVisible=true;l.fileVisible=false;this.getView().getModel("DocumentModel").setProperty("/doc"+o,l);this.onCheckComplete()},onDownloadFileButton:async function(e){let t=e.getParameter("id");let o=t.split("idDownloadFile")[1].split(".Icon")[0];let l=this.getView().getModel("DocumentModel").getProperty("/doc"+o);const r=document.createElement("a");let i=l.fileType;r.href="data:"+i+";base64,"+l.fileData;r.download=l.fileName;r.click()},onUploadFileSH:async function(e){let t=this.getOwnerComponent().getModel("AuthModel").getProperty("/authToken");let r=this.getView().getModel("ShareholderPopupModel").getProperty("/popup");let i=["image/png","application/pdf","image/jpeg","image/gif"];let n=document.createElement("input");n.type="file";n.multiple=false;n.accept="image/*";let s;let a;n.onchange=async function(){let e=n.files;s=e;for(let n=0;n<e.length;n++){if(i.includes(e[n].type)){let i=e[n];let p=await i.arrayBuffer();let u=await i.text();let d=new Uint8Array(p);let g=d.byteLength;for(let e=0;e<g;e++){a+=String.fromCharCode(d[e])}a=btoa(a);let c={fileContent:a};let f=await o.checkMalware(c,t);if(f==="true"){let e="Malware is detected";l.show(e)}else{r.fileName=s[0].name;r.fileType=s[0].type;r.fileData=a;r.uploadVisible=false;r.fileVisible=true;this.getView().getModel("ShareholderPopupModel").setProperty("/popup",r)}}else{this.showErrorMessageBox("Error","Invalid file type. Please select a PNG, PDF, or JPEG file.",null)}}}.bind(this);n.click()},onDeleteFileSH:async function(e){let t=this.getView().getModel("ShareholderPopupModel").getProperty("/popup");t.fileName=null;t.fileType=null;t.fileData=null;t.uploadVisible=true;t.fileVisible=false;this.getView().getModel("ShareholderPopupModel").setProperty("/popup",t)},onDownloadFileSH:async function(e){let t=this.getView().getModel("ShareholderPopupModel").getProperty("/popup");const o=document.createElement("a");o.href="data:"+t.fileType+";base64,"+t.fileData;o.download=t.fileName;o.click()},onEnterShareholderPopup:function(e){let o=e.getSource().getBindingContext("ShareholderModel");let l=this.getView().getModel("ShareholderModel").getProperty(o.getPath());l.path=o.getPath();let r=new t;r.setProperty("/popup",l);this.getView().setModel(r,"ShareholderPopupModel");if(!this._oDialog){this._oDialog=new sap.ui.xmlfragment("vbipsupplier.view.fragment.ShareholderPopup",this);this.getView().addDependent(this._oDialog)}this._oDialog.open()},onDialogAfterClose:function(){this._oDialog.destroy();this._oDialog=null},onSave:function(){let e=this.getView().getModel("ShareholderPopupModel").getProperty("/popup");let t={path:e.path,enterInfo:false,completed:true,name:e.name,sharePercentage:e.sharePercentage,address:e.address,docType:e.docType,docNum:e.docNum,nameOnDoc:e.nameOnDoc,dateOfIssue:e.dateOfIssue,filename:e.fileName,fileType:e.fileType,fileData:e.fileData,uploadVisible:false,fileVisible:true};this.getView().getModel("ShareholderModel").setProperty(`${e.path}`,t);this.onDialogAfterClose()},onCancel:function(){this.onDialogAfterClose()},onBackButtonPress:function(e){const t=e.getSource().getId();const o=t.split(".")[2];console.log(o);switch(o){case"InfoConfirm":this.getView().getModel("PageModel").setProperty("/pageFlow/infoConfirm",false);this.getView().getModel("PageModel").setProperty("/pageFlow/infoRequest",true);break;case"Corporate":this.getView().getModel("PageModel").setProperty("/pageFlow/corporate",false);this.getView().getModel("PageModel").setProperty("/pageFlow/infoConfirm",true);break;case"Shareholder":this.getView().getModel("PageModel").setProperty("/pageFlow/shareholder",false);this.getView().getModel("PageModel").setProperty("/pageFlow/corporate",true);break;default:break}},onCheckComplete:function(){for(let e=1;e<=9;e++){let t=this.getView().getModel("DocumentModel").getProperty("/doc"+e);if(t.nameOnDocument!==""&&t.documentNumber!==""&&t.fileName!==null){this.getView().getModel("DocumentModel").setProperty("/doc"+e+"/checked",true)}else{this.getView().getModel("DocumentModel").setProperty("/doc"+e+"/checked",false)}}},_onInit:async function(){let e="";let l=new t;let r={infoRequest:false,infoConfirm:false,corporate:false,shareholder:false,complete:false};l.setProperty("/pageFlow",r);this.getView().setModel(l,"PageModel");let i=new t;for(let e=1;e<=9;e++){i.setProperty("/doc"+e,{visible:false,nameOnDocument:null,documentNumber:null,fileName:null,fileType:null,fileData:null,uploadVisible:true,fileVisible:false})}i.setProperty("/docKeys",[1,2,3,4,5,6,7,8,9]);this.getView().setModel(i,"DocumentModel");let n=this.getOwnerComponent().getModel("SupplierInfo").getProperty("/supplier");let s=new t;let a=new t;let p,u,d;if(n!==undefined){e=this.getOwnerComponent().getModel("AuthModel").getProperty("/authToken");let t=await o.getBusinessNature(e);let l;if(t.response.value){l=t.response.value.businessNature.value}a.setProperty("/businessNature",l);if(n.SAPCustomer==="true"){p="true"}else if(n.SAPCustomer==="false"){p="false"}else if(n.SAPCustomer===null){p="true"}let r=n.shareholderCount;if(r===null){r=1}a.setProperty("/shareholderCount",r);this.getView().setModel(a,"F4");if(n.status==="CAC"){u="true";d=false}else{u="false";d=true}let i={SAPCustomer:p,acceptCard:u,infoBoxVisible:d};s.setProperty("/requestInfo",i);this.getView().setModel(s,"RequestInfo");this.getView().getModel("PageModel").setProperty("/pageFlow/infoRequest",true);let g=n.supplierDocuments;for(let e=0;e<=g.length-1;e++){let t={visible:true,nameOnDocument:g[e].nameOnDocument,documentNumber:g[e].documentNumber,fileName:g[e].fileName,fileType:g[e].fileType,fileData:null,uploadVisible:false,fileVisible:true};this.getView().getModel("DocumentModel").setProperty("/doc"+g[e].documentType,t)}this.onCheckComplete()}else{let e=this.getOwnerComponent().getRouter();e.navTo("Supplier",{GUID:"NotFound"})}this.onChangeBusinessNature();this.onChangeShareCount()},_setDefaultF4:async function(){let e=this.getOwnerComponent().getModel("SupplierInfo").getProperty("/supplier");if(e!==undefined){if(e.shareholderCount===null){e.shareholderCount=1}if(e.businessNature_selectKey===null){e.businessNature_selectKey=1}}},_onObjectMatched:function(e){this._onInit()},_updateSupplier:async function(e,t,r,i){let n=this.getOwnerComponent().getModel("AuthModel").getProperty("/authToken");let s=this.getOwnerComponent().getModel("SupplierInfo").getProperty("/supplier");let a=this.getView().getModel("DocumentModel").getProperty("/docKeys");let p=[];for(let e=0;e<=a.length-1;e++){let t=this.getView().getModel("DocumentModel").getProperty("/doc"+a[e]);let l={ID:s.supplierID,fileContent:t.fileData};let r=await o.encryptFile(l,n);p.push({documentName:"doc"+a[e],documentType:a[e].toString(),nameOnDocument:t.nameOnDocument,documentNumber:t.documentNumber,fileName:t.fileName,fileType:t.fileType,encodedContent:r.response.value})}let u,d;let g=[];if(r===true){u=parseInt(this.getView().byId("idBusinessNature.Select").getSelectedKey())}else{u=null}if(i===true){d=parseInt(this.getView().byId("idShareholderCount.Select").getSelectedKey());for(let e=0;e<=d-1;e++){let t=this.getView().getModel("ShareholderModel").getProperty("/item/"+e);if(t){let e={ID:s.supplierID,fileContent:t.fileData};let l=await o.encryptFile(e,n);g.push({shareholderName:t.name,sharePercentage:parseInt(t.sharePercentage),shareholderDocuments:[{documentType:t.docType,nameOnDocument:t.nameOnDoc,documentNumber:t.docNum,fileName:t.fileName,fileType:t.fileType,encodedContent:l.response.value,expiryDate:t.expiryDate}]})}}}else{d=null}let c={status:t,SAPCustomer:this.getView().byId("idSAPCustomer.Select").getSelectedKey().toLowerCase()==="true",businessNature_selectKey:u,shareholderCount:d,supplierDocuments:p,shareholderDetails:g};let f={buyerID:s.buyerID,supplierID:s.supplierID,oSupplier:c};let h=await o.updateSupplier(f,n);if(Object.keys(h.catchError).length===0&&h.catchError.constructor===Object){if(h.response.error){let e=`Operation failed Supplier ${s.supplierID} \nError code ${h.response.error.code}`}else{let t=`Supplier ${s.supplierID} information is update`;if(e==="message"){l.show(t)}}}else{let e=`Operation failed Supplier ${s.supplierID} \nError catched`}},_submitSupplier:async function(e){let t=this.getOwnerComponent().getModel("AuthModel").getProperty("/authToken");let r=this.getOwnerComponent().getModel("SupplierInfo").getProperty("/supplier");let i=this.getView().getModel("DocumentModel").getProperty("/docKeys");let n=[];for(let e=0;e<=i.length-1;e++){let l=this.getView().getModel("DocumentModel").getProperty("/doc"+i[e]);let s={ID:r.supplierID,fileContent:l.fileData};let a=await o.encryptFile(s,t);n.push({documentName:"doc"+i[e],nameOnDocument:l.nameOnDocument,documentNumber:l.documentNumber,fileName:l.fileName,encodedContent:a.response.value})}let s={vbipRequestId:r.buyerID+r.supplierID,businessNature:parseInt(r.businessNature_selectKey),shareHolderCount:parseInt(r.shareholderCount),isCardAcceptor:this.getView().byId("idAcceptCard.Select").getSelectedKey().toLowerCase()==="true",buyerId:r.buyerID,supplierInfo:{supplierId:r.supplierID,firstName:r.firstName,lastName:r.lastName,legalName:r.supplierName,emailAddress:r.emailID,mobileNumberCountryCode:r.mobileCountryCode,mobileNumber:r.mobileNumber,completeAddress:r.completeAddress,zipCode:r.zipCode,countryCode:r.countryCode_code,city:r.city,state:r.state},kycDetails:{addressProof:{documentName:"",nameOnDocument:"",documentNumber:"",fileName:"",encodedContent:""},businessProof:n},supplierBankingInfo:{accountHolderName:r.supplierName,accountNumber:r.accountNumber,branchCity:"",bankCode:r.bankCode}};let a={oSupplier:s};let p=await o.submitSupplier(a,t);if(Object.keys(p.catchError).length===0&&p.catchError.constructor===Object){if(p.response.error){let e=`Operation failed Supplier ${r.supplierID} \nError code ${p.response.error.code}`}else{let t=`Supplier ${r.supplierID} information is submitted`;if(e==="message"){l.show(t)}}}else{let e=`Operation failed Supplier ${r.supplierID} \nError catched`}},_endSession:function(){this.getOwnerComponent().getModel("LandingText").setProperty("/report",true);let e=this.getOwnerComponent().getRouter();e.navTo("Supplier",{GUID:"Info"})}})});