sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","../model/models","sap/m/MessageToast"],function(e,t,o,l){"use strict";return e.extend("vbipsupplier.controller.SupplierInfo",{onInit:function(){this._onInit();let e=sap.ui.core.UIComponent.getRouterFor(this);e.getRoute("SupplierInfo").attachPatternMatched(this._onObjectMatched,this)},onContinue:function(){this.getView().getModel("PageModel").setProperty("/pageFlow/infoRequest",false);let e=this.getView().byId("idAcceptCard.Select").getSelectedKey();if(e==="true"){this.getView().getModel("PageModel").setProperty("/pageFlow/complete",true)}else{this.getView().getModel("PageModel").setProperty("/pageFlow/infoConfirm",true)}},onConfirmInfo:function(){this.getView().getModel("PageModel").setProperty("/pageFlow/infoConfirm",false);this.getView().getModel("PageModel").setProperty("/pageFlow/corporate",true)},onContinueStep1:function(){this.getView().getModel("PageModel").setProperty("/pageFlow/corporate",false);this.getView().getModel("PageModel").setProperty("/pageFlow/shareholder",true)},onContinueStep2:function(){this.getView().getModel("PageModel").setProperty("/pageFlow/shareholder",false);this.getView().getModel("PageModel").setProperty("/pageFlow/complete",true);this._updateSupplier("noMessage")},onReportInfo:function(){},onSaveAndExit:async function(){this._updateSupplier("message");this.getView().getModel("PageModel").setProperty("/pageFlow/corporate",false);this.getView().getModel("PageModel").setProperty("/pageFlow/shareholder",false);this.getView().getModel("PageModel").setProperty("/pageFlow/infoRequest",true)},onChangeShareCount:function(){let e=new t;this.getView().setModel(e,"ShareholderModel");var o=this.getView().getModel("F4").getProperty("/shareholder/count");var l=[];for(var i=1;i<=o;i++){l.push({enterInfo:true,completed:false,name:"",sharePercentage:"",address:"",docType:"",docNum:"",nameOnDoc:"",dateOfIssue:"",filename:"",fileType:"",fileData:"",uploadVisible:true,fileVisible:false})}this.getView().getModel("ShareholderModel").setProperty("/item",l)},onUploadFileButton:async function(e){let t=e.getParameter("id");let o=t.split("idUploadFile")[1].split(".Button")[0];let l=document.createElement("input");l.type="file";l.multiple=true;l.accept="image/*";let i;l.onchange=async function(){let e=l.files;i=e;for(let o=0;o<e.length;o++){let l=e[o];let i=await l.arrayBuffer();let s=await l.text();var t=new Uint8Array(i);var r=t.byteLength;var a="";for(let e=0;e<r;e++){a+=String.fromCharCode(t[e])}a=btoa(a)}let s=this.getView().getModel("FileModel");s.setProperty("/file"+o,{fileName:i[0].name,fileType:i[0].type,fileData:a,uploadVisible:false,fileVisible:true})}.bind(this);l.click()},onDeleteFileButton:async function(e){let t=e.getParameter("id");let o=t.split("idDeleteFile")[1].split(".Icon")[0];let l=this.getView().getModel("FileModel");l.setProperty("/file"+o,{fileName:null,fileType:null,fileData:null,uploadVisible:true,fileVisible:false});this.getView().setModel(l,"FileModel")},onDownloadFileButton:async function(e){let t=e.getParameter("id");let o=t.split("idDownloadFile")[1].split(".Icon")[0];let l=this.getView().getModel("FileModel");let i=l.getProperty("/file"+o);const r=document.createElement("a");let a=i.fileType;r.href="data:"+a+";base64,"+i.fileData;r.download=i.fileName;r.click()},onUploadFileSH:async function(e){let t=this.getView().getModel("ShareholderPopupModel").getProperty("/popup");let o=e.getParameter("id");let l=o.split("idUploadFile")[1].split(".Button")[0];let i=document.createElement("input");i.type="file";i.multiple=true;i.accept="image/*";let r;i.onchange=async function(){let e=i.files;r=e;for(let t=0;t<e.length;t++){let i=e[t];let r=await i.arrayBuffer();let s=await i.text();var o=new Uint8Array(r);var l=o.byteLength;var a="";for(let e=0;e<l;e++){a+=String.fromCharCode(o[e])}a=btoa(a)}t.fileName=r[0].name;t.fileType=r[0].type;t.fileData=a;t.uploadVisible=false;t.fileVisible=true;this.getView().getModel("ShareholderPopupModel").setProperty("/popup",t)}.bind(this);i.click()},onEnterShareholderPopup:function(e){let o=e.getSource().getBindingContext("ShareholderModel");let l=this.getView().getModel("ShareholderModel").getProperty(o.getPath());l.path=o.getPath();let i=new t;i.setProperty("/popup",l);this.getView().setModel(i,"ShareholderPopupModel");if(!this._oDialog){this._oDialog=new sap.ui.xmlfragment("vbipsupplier.view.fragment.ShareholderPopup",this);this.getView().addDependent(this._oDialog)}this._oDialog.open()},onDialogAfterClose:function(){this._oDialog.destroy();this._oDialog=null},onSave:function(){let e=this.getView().getModel("ShareholderPopupModel").getProperty("/popup");let t={path:e.path,enterInfo:false,completed:true,name:e.name,sharePercentage:e.sharePercentage,address:e.address,address:"",docType:"",docNum:"",nameOnDoc:"",dateOfIssue:"",filename:"",fileType:"",fileData:"",uploadVisible:true,fileVisible:false};let o=this.getView().getModel("ShareholderPopupModel").getProperty("/popup/path");this.getView().getModel("ShareholderModel").setProperty(`${o}`,t);this.onDialogAfterClose()},onCancel:function(){this.onDialogAfterClose()},_onInit:async function(){let e=new t;let l={infoRequest:false,infoConfirm:false,corporate:false,shareholder:false,complete:false};e.setProperty("/pageFlow",l);this.getView().setModel(e,"PageModel");let i=new t;i.setProperty("/shareholder",{count:1});let r=await o.getBusinessNature();let a;if(r.response.value){a=r.response.value.businessNature.value}i.setProperty("/businessNature",a);this.getView().setModel(i,"F4");this.onChangeShareCount();let s=new t;for(let e=1;e<=2;e++){s.setProperty("/file"+e,{fileName:null,fileType:null,fileData:null,uploadVisible:true,fileVisible:false})}this.getView().setModel(s,"FileModel");let n=new t;let p,d;let u=this.getOwnerComponent().getModel("SupplierInfo").getProperty("/supplier");if(u!==undefined){if(u.SAPCustomer==="true"){p="true"}else if(u.SAPCustomer==="false"){p="false"}else if(u.SAPCustomer===null){p="true"}if(u.status===null||u.status==="Sent"){d="false"}else{d="true"}let e={SAPCustomer:p,acceptCard:d};n.setProperty("/requestInfo",e);this.getView().setModel(n,"RequestInfo");this.getView().getModel("PageModel").setProperty("/pageFlow/infoRequest",true)}else{let e=this.getOwnerComponent().getRouter();e.navTo("Supplier",{GUID:"NotFound"})}},_onObjectMatched:function(e){this._onInit()},_updateSupplier:async function(e){let t=this.getOwnerComponent().getModel("SupplierInfo").getProperty("/supplier");let i=this.getView().getModel("ShareholderModel").getProperty("/item");i.forEach(e=>e.sharePercentage=parseInt(e.sharePercentage));let r={status:"Saved",SAPCustomer:this.getView().byId("idSAPCustomer.Select").getSelectedKey().toLowerCase()==="true",businessNature:parseInt(this.getView().byId("idBusinessNature.Select").getSelectedKey()),shareholderCount:parseInt(this.getView().byId("idShareHolderCount.Select").getSelectedKey()),supplierDocuments:[{documentName:"copyOfBusinessReg",documentType:"copyOfBusinessReg",nameOnDocument:this.getView().byId("idNameDoc1.Input").getValue(),documentNumber:this.getView().byId("idDoc1.Input").getValue(),fileName:this.getView().getModel("FileModel").getProperty("/file1/fileName"),fileType:this.getView().getModel("FileModel").getProperty("/file1/fileName"),encodedContent:this.getView().getModel("FileModel").getProperty("/file1/fileName")},{documentName:"certOfIncorporation",documentType:"certOfIncorporation",nameOnDocument:this.getView().byId("idNameDoc2.Input").getValue(),documentNumber:this.getView().byId("idDoc2.Input").getValue(),fileName:this.getView().getModel("FileModel").getProperty("/file2/fileName"),fileType:this.getView().getModel("FileModel").getProperty("/file2/fileName"),encodedContent:this.getView().getModel("FileModel").getProperty("/file2/fileName")}]};let a={buyerID:t.buyerID,supplierID:t.supplierID,oSupplier:r};let s=await o.updateSupplier(a);if(Object.keys(s.catchError).length===0&&s.catchError.constructor===Object){if(s.response.error){let e=`Operation failed Supplier ${t.supplierID} \nError code ${s.response.error.code}`}else{let o=`Supplier ${t.supplierID} information is update`;if(e==="message"){l.show(o)}}}else{let e=`Operation failed Supplier ${t.supplierID} \nError catched`}}})});